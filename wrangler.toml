name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# é¿å…ä½µç™¼éƒ¨ç½²è¸©åˆ°å½¼æ­¤
concurrency:
  group: pet-republic-api-deploy
  cancel-in-progress: true

permissions:
  contents: read

env:
  # Cloudflare å¸³è™Ÿèˆ‡ API Token ä¾†è‡ª GitHub Secrets
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-24.04

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸš€ Wrangler deploy
        run: npx wrangler deploy
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}

      # å°‡ä»¥ä¸‹ Secretsï¼ˆå¦‚æœ‰æä¾›ï¼‰å¯«å…¥ Cloudflare Workerã€‚
      # é€™äº›åç¨±è¦èˆ‡ç¨‹å¼å…§ä½¿ç”¨çš„ env.* ç›¸åŒã€‚
      - name: ğŸ” Upload Worker secrets (if provided)
        shell: bash
        run: |
          set -euo pipefail

          put_secret () {
            local NAME="$1"
            local VALUE="$2"
            if [ -n "${VALUE}" ]; then
              echo "â€¢ putting secret: ${NAME}"
              # ä»¥ stdin æ–¹å¼å¯«å…¥ï¼Œé‡è¦†åŸ·è¡Œä¹Ÿå®‰å…¨
              printf '%s' "${VALUE}" | npx wrangler secret put "${NAME}" --quiet
            else
              echo "â€¢ skip ${NAME} (not provided)"
            fi
          }

          put_secret "AIRTABLE_API_TOKEN"   "${{ secrets.AIRTABLE_API_TOKEN }}"
          put_secret "AIRTABLE_BASE_ID"     "${{ secrets.AIRTABLE_BASE_ID }}"
          put_secret "AIRTABLE_TABLE_NAME"  "${{ secrets.AIRTABLE_TABLE_NAME }}"
          put_secret "USERNAME"             "${{ secrets.BASIC_AUTH_USERNAME || secrets.USERNAME }}"
          put_secret "PASSWORD"             "${{ secrets.BASIC_AUTH_PASSWORD || secrets.PASSWORD }}"
          put_secret "DOMAIN"               "${{ secrets.DOMAIN }}"

        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}

      - name: âœ… Summary
        run: |
          echo "Deployed to workers.dev (and your custom domain if routed in dashboard)."
          echo "Worker: pet-republic-api"
