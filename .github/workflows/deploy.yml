name: deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-24.04
    env:
      # 必填：Cloudflare API Token（Actions Secrets）
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      # 建議同時設置：Account ID（Actions Secrets）
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # 你專案需要的其他機密（如有）
      USERNAME: ${{ secrets.USERNAME }}
      PASSWORD: ${{ secrets.PASSWORD }}
      AIRTABLE_API_TOKEN: ${{ secrets.AIRTABLE_API_TOKEN }}
      AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
      AIRTABLE_TABLE_NAME: ${{ secrets.AIRTABLE_TABLE_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: npm install
        run: npm install

      - name: Show wrangler.toml & whoami
        shell: bash
        run: |
          echo "===== wrangler.toml ====="
          cat wrangler.toml || true
          echo "========================="
          npx wrangler --version
          npx wrangler whoami || true

      # 將需要的機密同步到 Worker（若沒設就跳過）
      - name: Upload Worker secrets (optional)
        shell: bash
        run: |
          set -euo pipefail
          put_secret() {
            local NAME="$1"; local VALUE="${!1:-}"
            if [ -n "${VALUE}" ]; then
              echo "Uploading secret ${NAME}..."
              echo -n "${VALUE}" | npx wrangler secret put "${NAME}" --env production --config wrangler.toml
            else
              echo "Skipping ${NAME} (not set)"
            fi
          }
          put_secret AIRTABLE_API_TOKEN
          put_secret AIRTABLE_BASE_ID
          put_secret AIRTABLE_TABLE_NAME
          put_secret USERNAME
          put_secret PASSWORD

      # 列出 D1，驗證權限正常
      - name: D1 list
        shell: bash
        run: |
          npx wrangler d1 list --env production --config wrangler.toml

      # 確認能對 image-db 執行 SQL（用名稱）
      - name: D1 ping (by name)
        shell: bash
        run: |
          npx wrangler d1 execute image-db \
            --command "SELECT 'ok' AS ping;" \
            --remote \
            --env production \
            --config wrangler.toml

      # ❶ 解析 image-db 的 UUID -> $DB_ID
      - name: Resolve D1 DB UUID
        id: d1id
        shell: bash
        run: |
          set -euo pipefail
          JSON=$(npx wrangler d1 list --env production --config wrangler.toml --json)
          DB_ID=$(node -e "const o=${JSON}; const arr = Array.isArray(o?.result) ? o.result : (Array.isArray(o) ? o : []); const db=arr.find(x=>x.name==='image-db'); if(!db){console.error('image-db not found'); process.exit(2)} console.log(db.uuid)")
          echo "DB_ID=$DB_ID"
          echo "DB_ID=$DB_ID" >> "$GITHUB_ENV"

      # ❷ 用 UUID + 指定 migrations 目錄「直接」套遷移
      # ⚠️ 關鍵修正：即使有 --database-id，也要傳入位置參數 <database>（這裡用 image-db）
      - name: Apply D1 migrations (UUID + positional)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -d "migrations" ]; then
            echo "⚠️  No migrations/ directory. Skipping migrations."
            exit 0
          fi
          if [ -z "${DB_ID:-}" ]; then
            echo "❌ DB_ID not resolved."
            exit 1
          fi
          npx wrangler d1 migrations apply "image-db" \
            --database-id "$DB_ID" \
            --migrations-dir "migrations" \
            --remote \
            --env production \
            --config wrangler.toml

      # 部署 Worker
      - name: Deploy Worker
        shell: bash
        run: |
          npx wrangler deploy --env production --config wrangler.toml
