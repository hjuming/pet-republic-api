name: deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-24.04
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm install

      - name: Apply D1 migrations (if any)
        run: |
          if [ -d "migrations" ]; then
            echo "ğŸ”§ Found migrations folder, applying..."
            npx wrangler d1 migrations apply image-db --remote
          else
            echo "âš ï¸ No migrations folder found. Skipping."
          fi

      - name: Deploy with Wrangler
        run: npx wrangler deploy

      # ï¼ˆå¯é¸ï¼‰è‡ªå‹•ä¸Šå‚³ Secretsï¼›ä½ è‹¥æ”¹åœ¨ Dashboard ç®¡ï¼Œå°±æŠŠé€™æ­¥åˆªæ‰
      - name: Set secrets (optional)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          put_secret() {
            local NAME="$1"
            local VALUE="$2"
            if [ -n "$VALUE" ]; then
              echo "Uploading secret $NAME..."
              # âš ï¸ wrangler v4 ä¸æ”¯æ´ --yesï¼›ä»¥ stdin å‚³å…¥å€¼å³å¯éäº’å‹•å¯«å…¥
              echo "$VALUE" | npx wrangler secret put "$NAME"
            else
              echo "Skipping $NAME (not set)"
            fi
          }
          put_secret "USERNAME" "${{ secrets.USERNAME }}"
          put_secret "PASSWORD" "${{ secrets.PASSWORD }}"
          put_secret "AIRTABLE_API_TOKEN" "${{ secrets.AIRTABLE_API_TOKEN }}"
          put_secret "AIRTABLE_BASE_ID" "${{ secrets.AIRTABLE_BASE_ID }}"
          put_secret "AIRTABLE_TABLE_NAME" "${{ secrets.AIRTABLE_TABLE_NAME }}"
