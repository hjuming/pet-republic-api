name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: pet-republic-api-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: deploy
    runs-on: ubuntu-24.04
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      AIRTABLE_API_TOKEN: ${{ secrets.AIRTABLE_API_TOKEN }}
      AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
      AIRTABLE_TABLE_NAME: ${{ secrets.AIRTABLE_TABLE_NAME }}
      USERNAME: ${{ secrets.BASIC_AUTH_USERNAME }}
      PASSWORD: ${{ secrets.BASIC_AUTH_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm install

      - name: Show wrangler.toml & whoami
        run: |
          echo "===== wrangler.toml ====="
          cat wrangler.toml || true
          echo "========================="
          npx wrangler --version
          npx wrangler whoami || true

      # 將 Secrets 寫回 Worker（避免「被洗掉」）
      - name: Upload Worker secrets
        shell: bash
        run: |
          set -euo pipefail
          put_secret() {
            local NAME="$1"; local VALUE="${!1:-}"
            if [ -n "${VALUE}" ]; then
              echo "Uploading secret ${NAME}..."
              echo -n "${VALUE}" | npx wrangler secret put "${NAME}" --env production --config wrangler.toml
            else
              echo "Skipping ${NAME} (not set)"
            fi
          }
          put_secret AIRTABLE_API_TOKEN
          put_secret AIRTABLE_BASE_ID
          put_secret AIRTABLE_TABLE_NAME
          put_secret USERNAME
          put_secret PASSWORD

      - name: Locate D1 (sanity check)
        id: d1
        shell: bash
        run: |
          set -euo pipefail
          npx wrangler d1 list --env production --config wrangler.toml
          # Ping DB（remote）
          npx wrangler d1 execute image-db \
            --command "SELECT 'ok' AS ping;" \
            --remote \
            --env production \
            --config wrangler.toml

      - name: Apply D1 migrations (binding: DATABASE)
        if: ${{ hashFiles('migrations/**') != '' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Found migrations dir:"
          ls -1 migrations
          # ⚠️ 必須用 binding 名稱（DATABASE），不可用 database_name（image-db）
          npx wrangler d1 migrations apply DATABASE \
            --remote \
            --env production \
            --config wrangler.toml

      - name: Deploy Worker
        run: |
          npx wrangler deploy --env production --config wrangler.toml

      - name: Post Setup Node.js
        if: always()
        run: node -v
