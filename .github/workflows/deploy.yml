name: Deploy Pet Republic API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# ğŸ§© é¿å…ä½µç™¼éƒ¨ç½²
concurrency:
  group: pet-republic-api-deploy
  cancel-in-progress: true

permissions:
  contents: read

env:
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-24.04

    steps:
      # ==========================================================
      # 1ï¸âƒ£ æº–å‚™ç’°å¢ƒ
      # ==========================================================
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # ==========================================================
      # 2ï¸âƒ£ éƒ¨ç½² Worker
      # ==========================================================
      - name: ğŸš€ Deploy Worker to Cloudflare
        run: npx wrangler deploy
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}

      # ==========================================================
      # 3ï¸âƒ£ è‡ªå‹•åŸ·è¡Œ D1 Migrations
      # ==========================================================
      - name: ğŸ—„ï¸ Run D1 migrations (remote)
        run: |
          if [ -d "migrations" ]; then
            echo "Detected migrations folder, executing SQL files..."
            for f in migrations/*.sql; do
              echo "â†’ Applying migration: $f"
              npx wrangler d1 execute image-db --remote --file "$f"
            done
          else
            echo "No migrations folder found. Skipping."
          fi
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}

      # ==========================================================
      # 4ï¸âƒ£ è¨­å®š Secretsï¼ˆå®‰å…¨å¯é‡è¤‡ï¼‰
      # ==========================================================
      - name: ğŸ” Upload Worker secrets (idempotent)
        shell: bash
        run: |
          set -euo pipefail

          put_secret () {
            local NAME="$1"
            local VALUE="$2"
            if [ -n "${VALUE}" ]; then
              echo "â€¢ putting secret: ${NAME}"
              printf '%s' "${VALUE}" | npx wrangler secret put "${NAME}" --quiet
            else
              echo "â€¢ skip ${NAME} (not provided)"
            fi
          }

          put_secret "AIRTABLE_API_TOKEN"   "${{ secrets.AIRTABLE_API_TOKEN }}"
          put_secret "AIRTABLE_BASE_ID"     "${{ secrets.AIRTABLE_BASE_ID }}"
          put_secret "AIRTABLE_TABLE_NAME"  "${{ secrets.AIRTABLE_TABLE_NAME }}"
          put_secret "USERNAME"             "${{ secrets.BASIC_AUTH_USERNAME || secrets.USERNAME }}"
          put_secret "PASSWORD"             "${{ secrets.BASIC_AUTH_PASSWORD || secrets.PASSWORD }}"
          put_secret "DOMAIN"               "${{ secrets.DOMAIN }}"

        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}

      # ==========================================================
      # 5ï¸âƒ£ éƒ¨ç½²æ‘˜è¦
      # ==========================================================
      - name: âœ… Deployment summary
        run: |
          echo "============================================"
          echo "ğŸš€ Pet Republic API å·²æˆåŠŸéƒ¨ç½²"
          echo "Worker åç¨±ï¼špet-republic-api"
          echo "D1 è³‡æ–™åº«ï¼šimage-db"
          echo "R2 å„²å­˜æ¡¶ï¼šmy-images-bucket"
          echo "è‡ªå‹•åŸ·è¡Œ migrations å®Œæˆ"
          echo "============================================"
