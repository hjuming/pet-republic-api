name: deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-24.04
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN:  ${{ secrets.CLOUDFLARE_API_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm install

      - name: Show wrangler config (debug)
        run: |
          echo "===== wrangler.toml ====="
          cat wrangler.toml || true
          echo "========================="
          npx wrangler --version
          npx wrangler whoami || true

      # âœ… é€™æ­¥æœƒç”¨ wrangler.toml çš„ binding åç¨±ã€ŒDATABASEã€
      - name: Apply D1 migrations (remote)
        shell: bash
        run: |
          if [ -d "migrations" ]; then
            echo "ğŸ”§ Applying D1 migrations to binding: DATABASE ..."
            npx wrangler d1 migrations apply DATABASE --remote --config wrangler.toml
          else
            echo "âš ï¸ No migrations folder found. Skipping."
          fi

      - name: Deploy Worker (default env)
        run: npx wrangler deploy --config wrangler.toml

      # ï¼ˆé¸ç”¨ï¼‰æŠŠå¯†é‘°å¯«å› Workerï¼Œé¿å…è¢«è¦†è“‹æ™‚éºå¤±
      - name: Upload secrets to Worker
        shell: bash
        run: |
          set -euo pipefail
          put_secret () { local NAME="$1"; local VALUE="$2"; if [ -n "$VALUE" ]; then echo "$VALUE" | npx wrangler secret put "$NAME" --config wrangler.toml; else echo "Skip $NAME (empty)"; fi; }
          put_secret "USERNAME"               "${{ secrets.USERNAME }}"
          put_secret "PASSWORD"               "${{ secrets.PASSWORD }}"
          put_secret "AIRTABLE_API_TOKEN"     "${{ secrets.AIRTABLE_API_TOKEN }}"
          put_secret "AIRTABLE_BASE_ID"       "${{ secrets.AIRTABLE_BASE_ID }}"
          put_secret "AIRTABLE_TABLE_NAME"    "${{ secrets.AIRTABLE_TABLE_NAME }}"
