name: deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-24.04
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

    steps:
      # ==========================================================
      # 1ï¸âƒ£ å–å¾—ç¨‹å¼ç¢¼
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==========================================================
      # 2ï¸âƒ£ è¨­å®š Node.js ç’°å¢ƒï¼ˆä¸ä½¿ç”¨å¿«å–ï¼‰
      # ==========================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # âš ï¸ è‹¥ä¹‹å¾ŒåŠ å…¥ package-lock.jsonï¼Œå¯æ‰“é–‹ cache
          # cache: 'npm'

      # ==========================================================
      # 3ï¸âƒ£ å®‰è£ä¾è³´å¥—ä»¶
      # ==========================================================
      - name: Install dependencies
        run: npm install

      # ==========================================================
      # 4ï¸âƒ£ è‡ªå‹•åŸ·è¡Œ D1 migrationsï¼ˆç¢ºä¿è³‡æ–™è¡¨çµæ§‹æ­£ç¢ºï¼‰
      # ==========================================================
      - name: Apply D1 migrations (remote)
        run: |
          if [ -d "migrations" ]; then
            echo "ğŸ”§ Found migrations folder, applying..."
            npx wrangler d1 migrations apply image-db --remote
          else
            echo "âš ï¸ No migrations folder found. Skipping."
          fi
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}

      # ==========================================================
      # 5ï¸âƒ£ éƒ¨ç½²è‡³ Cloudflare Workers
      # ==========================================================
      - name: Deploy with Wrangler
        run: npx wrangler deploy
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}

      # ==========================================================
      # 6ï¸âƒ£ ä¸Šå‚³ Secretsï¼ˆå¯é¸ï¼Œè‹¥ Dashboard å·²è¨­å¯çœç•¥ï¼‰
      # ==========================================================
      - name: Set secrets (optional)
        if: always()
        run: |
          put_secret() {
            local NAME="$1"
            local VALUE="$2"
            if [ -n "$VALUE" ]; then
              echo "Uploading secret $NAME..."
              echo "$VALUE" | npx wrangler secret put "$NAME" --yes
            else
              echo "Skipping $NAME (not set)"
            fi
          }

          put_secret "USERNAME" "${{ secrets.USERNAME }}"
          put_secret "PASSWORD" "${{ secrets.PASSWORD }}"
          put_secret "AIRTABLE_API_TOKEN" "${{ secrets.AIRTABLE_API_TOKEN }}"
          put_secret "AIRTABLE_BASE_ID" "${{ secrets.AIRTABLE_BASE_ID }}"
          put_secret "AIRTABLE_TABLE_NAME" "${{ secrets.AIRTABLE_TABLE_NAME }}"
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}

      # ==========================================================
      # 7ï¸âƒ£ å®Œæˆè¨Šæ¯
      # ==========================================================
      - name: âœ… Deployment summary
        run: |
          echo "============================================"
          echo "ğŸš€ å¯µå…’å…±å’Œåœ‹ API å·²æˆåŠŸéƒ¨ç½²"
          echo "Worker: pet-republic-api"
          echo "D1 Database: image-db"
          echo "R2 Bucket: my-images-bucket"
          echo "============================================"
