<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>寵兒共和國｜商品一覽</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
    <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <h1 class="text-2xl font-bold">商品一覽</h1>
      <div class="flex flex-wrap items-center gap-2">
        <input id="search" type="search" placeholder="搜尋 SKU / 品名 / 品牌 / 類別…" class="w-64 rounded-lg border border-gray-300 px-3 py-2 focus:border-teal-600 focus:outline-none"/>
        <select id="status" class="rounded-lg border border-gray-300 px-2 py-2">
          <option value="active">僅顯示上架</option>
          <option value="">全部狀態</option>
        </select>
        <div class="inline-flex rounded-lg border border-gray-300 overflow-hidden">
          <button id="viewGrid" class="px-3 py-2 bg-white hover:bg-gray-100">縮圖</button>
          <button id="viewList" class="px-3 py-2 bg-white hover:bg-gray-100">清單</button>
        </div>
        <button id="exportCSV" class="rounded-lg bg-teal-600 px-4 py-2 text-white hover:bg-teal-700">匯出 CSV</button>
        <button id="exportZIP" class="rounded-lg bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">打包圖片 ZIP</button>
      </div>
    </header>

    <main class="mt-6 grid grid-cols-1 gap-6 md:grid-cols-4">
      <!-- 左側篩選 -->
      <aside class="md:col-span-1">
        <div class="sticky top-4 space-y-6">
          <section>
            <h2 class="mb-2 font-semibold">BRAND</h2>
            <div id="facetBrand" class="space-y-1 max-h-[48vh] overflow-auto pr-2"></div>
          </section>
          <section>
            <h2 class="mb-2 font-semibold">CATEGORY</h2>
            <div id="facetCategory" class="space-y-1 max-h-[48vh] overflow-auto pr-2"></div>
          </section>
          <button id="clearFilters" class="mt-2 text-sm text-teal-700 hover:underline">清除篩選</button>
        </div>
      </aside>

      <!-- 內容區 -->
      <section class="md:col-span-3">
        <div class="mb-3 flex items-center justify-between text-sm text-gray-600">
          <label class="inline-flex items-center gap-2">
            <input id="selectAllPage" type="checkbox" class="h-4 w-4 rounded border-gray-300"/>
            <span>勾選本頁全部</span>
          </label>
          <div id="pager" class="flex items-center gap-2"></div>
        </div>

        <!-- Grid/List 容器 -->
        <div id="grid" class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-4"></div>
        <table id="list" class="hidden w-full table-auto text-sm">
          <thead>
            <tr class="bg-gray-100 text-left">
              <th class="p-2 w-10"></th>
              <th class="p-2">SKU</th>
              <th class="p-2">商品</th>
              <th class="p-2">品牌</th>
              <th class="p-2">類別</th>
              <th class="p-2 text-right">售價</th>
            </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>
      </section>
    </main>
  </div>

<script>
(() => {
  // === 可調整：API 位置 ===
  const API_BASE = 'https://image.wedo.pet';

  // === 狀態 ===
  let state = {
    q: '',
    brand: '',
    category: '',
    status: 'active',
    page: 1,
    size: 24,
    view: 'grid', // 'grid' | 'list'
    items: [],
    total: 0,
    pages: 1,
    facets: { brand: [], category: [] },
    selected: new Set(), // sku
  };

  // === DOM ===
  const $ = (s) => document.querySelector(s);
  const grid = $('#grid');
  const list = $('#list');
  const listBody = $('#listBody');
  const pager = $('#pager');
  const facetBrand = $('#facetBrand');
  const facetCategory = $('#facetCategory');

  // === 初始化 ===
  bindUI();
  load();

  function bindUI() {
    // 搜尋、狀態
    $('#search').addEventListener('input', debounce(() => {
      state.q = $('#search').value.trim();
      state.page = 1; load();
    }, 300));

    $('#status').addEventListener('change', () => {
      state.status = $('#status').value || '';
      state.page = 1; load();
    });

    // 檢視切換
    $('#viewGrid').addEventListener('click', () => { state.view='grid'; render(); });
    $('#viewList').addEventListener('click', () => { state.view='list'; render(); });

    // 匯出
    $('#exportCSV').addEventListener('click', exportCSV);
    $('#exportZIP').addEventListener('click', exportZip);

    // 清篩
    $('#clearFilters').addEventListener('click', () => {
      state.brand = '';
      state.category = '';
      state.page = 1; load();
    });

    // 勾選本頁
    $('#selectAllPage').addEventListener('change', (e) => {
      const checked = e.target.checked;
      currentPageSKUs().forEach(sku => checked ? state.selected.add(sku) : state.selected.delete(sku));
      render(); // 更新 checkbox UI
    });
  }

  async function load() {
    const params = new URLSearchParams();
    if (state.q) params.set('q', state.q);
    if (state.brand) params.set('brand', state.brand);
    if (state.category) params.set('category', state.category);
    if (state.status) params.set('status', state.status);
    params.set('page', state.page);
    params.set('size', state.size);

    const res = await fetch(`${API_BASE}/api/products?` + params.toString());
    const data = await res.json();
    state.items = data.items || [];
    state.total = data.total || 0;
    state.pages = data.pages || 1;
    state.facets = data.facets || { brand: [], category: [] };
    renderFacets();
    render();
  }

  function renderFacets() {
    facetBrand.innerHTML = (state.facets.brand || [])
      .map(b => `<label class="flex items-center justify-between gap-2 rounded px-2 py-1 hover:bg-gray-100">
        <span class="flex-1 cursor-pointer" data-brand="${escapeAttr(b.k)}">${escapeHTML(b.k)}</span>
        <span class="text-xs text-gray-500">${b.n}</span>
      </label>`).join('') || '<div class="text-sm text-gray-400">—</div>';

    facetCategory.innerHTML = (state.facets.category || [])
      .map(c => `<label class="flex items-center justify-between gap-2 rounded px-2 py-1 hover:bg-gray-100">
        <span class="flex-1 cursor-pointer" data-category="${escapeAttr(c.k)}">${escapeHTML(c.k)}</span>
        <span class="text-xs text-gray-500">${c.n}</span>
      </label>`).join('') || '<div class="text-sm text-gray-400">—</div>';

    facetBrand.querySelectorAll('[data-brand]').forEach(el => {
      el.addEventListener('click', () => { state.brand = el.dataset.brand; state.page=1; load(); });
    });
    facetCategory.querySelectorAll('[data-category]').forEach(el => {
      el.addEventListener('click', () => { state.category = el.dataset.category; state.page=1; load(); });
    });
  }

  function render() {
    // 分頁
    pager.innerHTML = `
      <button ${state.page<=1?'disabled':''} class="rounded border px-3 py-1 ${state.page<=1?'opacity-50':''}" id="prev">上一頁</button>
      <span>第 <b>${state.page}</b> / ${state.pages} 頁　共 ${state.total} 筆</span>
      <button ${state.page>=state.pages?'disabled':''} class="rounded border px-3 py-1 ${state.page>=state.pages?'opacity-50':''}" id="next">下一頁</button>
    `;
    pager.querySelector('#prev')?.addEventListener('click', () => { if (state.page>1) { state.page--; load(); }});
    pager.querySelector('#next')?.addEventListener('click', () => { if (state.page<state.pages) { state.page++; load(); }});

    // 視圖
    if (state.view === 'grid') {
      grid.classList.remove('hidden');
      list.classList.add('hidden');
      grid.innerHTML = state.items.map(item => card(item)).join('');
      grid.querySelectorAll('input[type="checkbox"][data-sku]').forEach(ck => {
        ck.checked = state.selected.has(ck.dataset.sku);
        ck.addEventListener('change', () => {
          ck.checked ? state.selected.add(ck.dataset.sku) : state.selected.delete(ck.dataset.sku);
        });
      });
    } else {
      list.classList.remove('hidden');
      grid.classList.add('hidden');
      listBody.innerHTML = state.items.map(row => tr(row)).join('');
      listBody.querySelectorAll('input[type="checkbox"][data-sku]').forEach(ck => {
        ck.checked = state.selected.has(ck.dataset.sku);
        ck.addEventListener('change', () => {
          ck.checked ? state.selected.add(ck.dataset.sku) : state.selected.delete(ck.dataset.sku);
        });
      });
    }
  }

  function card(p) {
    const img = p.image ? `${API_BASE}${p.image}` : 'https://via.placeholder.com/400x400?text=No+Image';
    return `
    <div class="rounded-xl border bg-white p-3 shadow-sm hover:shadow">
      <div class="relative aspect-square overflow-hidden rounded-lg bg-gray-100">
        <img src="${img}" alt="${escapeAttr(p.name)}" class="h-full w-full object-contain"/>
        <label class="absolute left-2 top-2 inline-flex items-center gap-2 rounded bg-white/90 px-2 py-1 text-xs shadow">
          <input type="checkbox" data-sku="${escapeAttr(p.sku)}" class="h-4 w-4"/>
          <span>選取</span>
        </label>
      </div>
      <div class="mt-2 text-xs text-gray-500">${escapeHTML(p.brand||'-')}｜${escapeHTML(p.category||'-')}</div>
      <div class="mt-1 truncate-2 font-medium" title="${escapeAttr(p.name)}">${escapeHTML(p.name)}</div>
      <div class="mt-1 text-sm text-gray-600">${escapeHTML(p.sku)}</div>
      <div class="mt-1 text-right font-semibold text-teal-700">NT$ ${(p.price/100).toLocaleString()}</div>
    </div>`;
  }

  function tr(p) {
    return `
    <tr class="border-b">
      <td class="p-2"><input type="checkbox" data-sku="${escapeAttr(p.sku)}" class="h-4 w-4"/></td>
      <td class="p-2 font-mono">${escapeHTML(p.sku)}</td>
      <td class="p-2">${escapeHTML(p.name)}</td>
      <td class="p-2">${escapeHTML(p.brand||'-')}</td>
      <td class="p-2">${escapeHTML(p.category||'-')}</td>
      <td class="p-2 text-right">NT$ ${(p.price/100).toLocaleString()}</td>
    </tr>`;
  }

  function currentPageSKUs() { return state.items.map(x => x.sku); }

  async function exportCSV() {
    const targetSkus = state.selected.size ? Array.from(state.selected) : currentPageSKUs();
    if (!targetSkus.length) return alert('沒有可匯出的商品');
    // 取詳細資料（含圖片）
    const rows = [];
    for (const sku of targetSkus) {
      const res = await fetch(`${API_BASE}/api/products/${encodeURIComponent(sku)}`);
      const d = await res.json();
      if (!d?.product) continue;
      const p = d.product;
      const firstImg = (d.images?.[0]?.url) ? `${API_BASE}${d.images[0].url}` : '';
      rows.push({
        sku: p.sku, name: p.name, brand: p.brand||'', category: p.category||'',
        price: (Number(p.price)||0)/100, status: p.status, stock: p.stock,
        image: firstImg
      });
    }
    // 轉 CSV
    const header = ['SKU','Name','Brand','Category','Price','Status','Stock','Image'];
    const csv = [header.join(','), ...rows.map(r => [
      escCSV(r.sku), escCSV(r.name), escCSV(r.brand), escCSV(r.category),
      r.price, escCSV(r.status), r.stock, escCSV(r.image)
    ].join(','))].join('\n');
    saveAs(new Blob([csv], {type:'text/csv;charset=utf-8'}), `products_${Date.now()}.csv`);
  }

  async function exportZip() {
    const targetSkus = state.selected.size ? Array.from(state.selected) : currentPageSKUs();
    if (!targetSkus.length) return alert('沒有可下載的商品');
    const zip = new JSZip();
    let added = 0;

    for (const sku of targetSkus) {
      const res = await fetch(`${API_BASE}/api/products/${encodeURIComponent(sku)}/images`);
      const data = await res.json();
      const imgs = data.items || [];
      for (const it of imgs) {
        const url = `${API_BASE}${it.url}`;
        try {
          const resp = await fetch(url);
          if (!resp.ok) continue;
          const ab = await resp.arrayBuffer();
          const fname = it.filename || url.split('/').pop();
          zip.file(`${sku}/${fname}`, ab);
          added++;
        } catch (e) {}
      }
    }

    if (!added) return alert('找不到可下載的圖片');
    const blob = await zip.generateAsync({type:'blob'});
    saveAs(blob, `product_images_${Date.now()}.zip`);
  }

  // === utils ===
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  function escapeHTML(s=''){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function escapeAttr(s=''){ return escapeHTML(String(s)); }
  function escCSV(v){ if(v==null) return ''; const s=String(v).replace(/"/g,'""'); return /[",\n]/.test(s)?`"${s}"`:s; }
})();
</script>
</body>
</html>
