<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>寵兒共和國｜商品一覽</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 壓縮圖片用（前端打包 ZIP） -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    .grid-auto-fill { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    .truncate-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- 顶部 -->
  <header class="sticky top-0 z-40 bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="/" class="text-xl font-bold">寵兒共和國</a>
      <div class="ml-auto w-full max-w-xl relative">
        <input id="q" class="w-full rounded-lg border-gray-300 pe-28" placeholder="搜尋關鍵字或輸入 SKU…" />
        <button id="clearSearch" class="absolute right-2 top-1/2 -translate-y-1/2 text-sm text-gray-500 hover:text-gray-900">清除</button>
      </div>
      <div class="flex items-center gap-2">
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="modeToggle" type="checkbox" class="rounded" />
          清單模式
        </label>
        <button id="exportCsvBtn" disabled class="px-3 py-2 text-sm rounded-lg bg-teal-600 text-white disabled:opacity-40">匯出選取（CSV）</button>
        <div class="relative">
          <button id="exportZipBtn" disabled class="px-3 py-2 text-sm rounded-lg bg-indigo-600 text-white disabled:opacity-40">下載圖片（ZIP）</button>
        </div>
      </div>
    </div>
  </header>

  <!-- 主內容 -->
  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-12 gap-6">
    <!-- 側欄 -->
    <aside class="col-span-12 md:col-span-3">
      <div class="bg-white rounded-xl shadow-sm border p-4 space-y-6">
        <section>
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">BRAND</h3>
            <button id="clearBrand" class="text-sm text-teal-700">清除</button>
          </div>
          <div id="brandList" class="mt-2 space-y-2 text-sm max-h-72 overflow-auto"></div>
        </section>
        <section>
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">CATEGORY</h3>
            <button id="clearCategory" class="text-sm text-teal-700">清除</button>
          </div>
          <div id="categoryList" class="mt-2 space-y-2 text-sm max-h-80 overflow-auto"></div>
        </section>
        <section>
          <h3 class="font-semibold">其他</h3>
          <label class="inline-flex items-center gap-2 text-sm mt-2">
            <input id="onlyInStock" type="checkbox" class="rounded" />
            只看有庫存
          </label>
        </section>
      </div>
    </aside>

    <!-- 列表 -->
    <section class="col-span-12 md:col-span-9">
      <div class="bg-white rounded-xl shadow-sm border">
        <!-- 批次動作 & 分頁資訊 -->
        <div class="p-3 flex items-center gap-3 border-b">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="selectAll" type="checkbox" class="rounded" />
            全選（目前結果）
          </label>
          <span id="countText" class="text-sm text-gray-500"></span>
        </div>

        <!-- Grid/List 容器 -->
        <div id="gridWrap" class="p-4 grid grid-auto-fill gap-4"></div>
        <div id="listWrap" class="hidden">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 border-b">
              <tr>
                <th class="w-10 p-2"></th>
                <th class="text-left p-2">SKU</th>
                <th class="text-left p-2">商品名稱</th>
                <th class="text-left p-2">品牌</th>
                <th class="text-left p-2">分類</th>
                <th class="text-right p-2">售價</th>
                <th class="text-right p-2">庫存</th>
              </tr>
            </thead>
            <tbody id="listBody"></tbody>
          </table>
        </div>

        <!-- 載入更多（簡易分批載入） -->
        <div class="p-4 border-t flex justify-center">
          <button id="loadMore" class="px-4 py-2 text-sm rounded-lg border hover:bg-gray-50">載入更多</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = '/api';
    const IMAGE_BASE = 'https://image.wedo.pet'; // 你的 Worker 綁定網域
    const PAGE_SIZE = 60;

    // 畫面狀態
    let allProducts = [];     // 從後端抓到的全集（分批）
    let renderedCount = 0;    // 已渲染數（用於載入更多）
    const selected = new Set();
    const state = { q:'', brand:null, category:null, onlyInStock:false, listMode:false };

    // DOM
    const qEl = document.getElementById('q');
    const clearSearchEl = document.getElementById('clearSearch');
    const brandListEl = document.getElementById('brandList');
    const categoryListEl = document.getElementById('categoryList');
    const clearBrandEl = document.getElementById('clearBrand');
    const clearCategoryEl = document.getElementById('clearCategory');
    const onlyInStockEl = document.getElementById('onlyInStock');
    const modeToggleEl = document.getElementById('modeToggle');
    const gridWrap = document.getElementById('gridWrap');
    const listWrap = document.getElementById('listWrap');
    const listBody = document.getElementById('listBody');
    const selectAllEl = document.getElementById('selectAll');
    const countText = document.getElementById('countText');
    const loadMoreBtn = document.getElementById('loadMore');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportZipBtn = document.getElementById('exportZipBtn');

    // 初始化
    init();
    async function init() {
      await fetchMore();       // 先載入一批
      buildFacets();           // 建立品牌/分類側欄
      render();                // 畫面渲染
      bindEvents();
    }

    // 從後端分批抓資料
    async function fetchMore() {
      const res = await fetch(`${API_BASE}/products?status=active&limit=${PAGE_SIZE}&offset=${allProducts.length}`);
      const json = await res.json();
      allProducts = allProducts.concat(json.items || []);
      // 物件補齊欄位
      for (const p of allProducts) {
        p.price = p.price ?? 0;
        p.images = p.images || []; // 後端如有附帶，直接使用；若沒有再用 /api 查
      }
      // 是否還有更多
      loadMoreBtn.disabled = !(json.items && json.items.length === PAGE_SIZE);
      if (loadMoreBtn.disabled) loadMoreBtn.textContent = '已全部載入';
    }

    // 側欄 Facets
    function buildFacets() {
      const brandMap = new Map();
      const cateMap = new Map();
      for (const p of allProducts) {
        const b = (p.brand || '未標示').trim();
        brandMap.set(b, (brandMap.get(b) || 0) + 1);
        const c = (p.category || '未標示').trim();
        cateMap.set(c, (cateMap.get(c) || 0) + 1);
      }
      brandListEl.innerHTML = [...brandMap.entries()].sort().map(([k,v]) =>
        `<label class="flex items-center justify-between gap-2 cursor-pointer">
          <input type="radio" name="brand" value="${escapeHtml(k)}" class="brand-radio">
          <span>${escapeHtml(k)}</span>
          <span class="text-gray-400">(${v})</span>
        </label>`).join('');
      categoryListEl.innerHTML = [...cateMap.entries()].sort().map(([k,v]) =>
        `<label class="flex items-center justify-between gap-2 cursor-pointer">
          <input type="radio" name="category" value="${escapeHtml(k)}" class="category-radio">
          <span>${escapeHtml(k)}</span>
          <span class="text-gray-400">(${v})</span>
        </label>`).join('');
    }

    // 篩選結果
    function getFiltered() {
      return allProducts.filter(p => {
        if (state.q) {
          const q = state.q.toLowerCase();
          const hit = (p.name||'').toLowerCase().includes(q) ||
                      (p.sku||'').toLowerCase().includes(q);
          if (!hit) return false;
        }
        if (state.brand && (p.brand||'未標示') !== state.brand) return false;
        if (state.category && (p.category||'未標示') !== state.category) return false;
        if (state.onlyInStock && (p.stock||0) <= 0) return false;
        return true;
      });
    }

    // 渲染
    function render(reset=false) {
      const list = getFiltered();
      countText.textContent = `共 ${list.length} 項商品，已選取 ${selected.size} 項`;
      exportCsvBtn.disabled = selected.size === 0;
      exportZipBtn.disabled = selected.size === 0;

      // 模式切換
      if (state.listMode) {
        gridWrap.classList.add('hidden');
        listWrap.classList.remove('hidden');
        renderListTable(list, reset);
      } else {
        listWrap.classList.add('hidden');
        gridWrap.classList.remove('hidden');
        renderGrid(list, reset);
      }
    }

    // Grid 渲染（縮圖卡片）
    function renderGrid(list, reset) {
      if (reset) { gridWrap.innerHTML = ''; renderedCount = 0; }
      const slice = list.slice(renderedCount, renderedCount + PAGE_SIZE);
      const html = slice.map(p => {
        const thumb = p.images?.[0]?.filename ? `${IMAGE_BASE}/${encodeURIComponent(p.sku)}/${encodeURIComponent(p.images[0].filename)}` : '';
        return `<div class="border rounded-xl overflow-hidden flex flex-col">
          <div class="aspect-[4/3] bg-gray-100 flex items-center justify-center">
            ${thumb ? `<img src="${thumb}" alt="${escapeHtml(p.name)}" class="max-h-full">` : `<span class="text-gray-400 text-sm">No Image</span>`}
          </div>
          <div class="p-3 space-y-1">
            <label class="inline-flex items-center gap-2 text-sm">
              <input type="checkbox" data-sku="${escapeHtml(p.sku)}" class="pick rounded" ${selected.has(p.sku) ? 'checked':''} />
              <span class="font-mono">${escapeHtml(p.sku)}</span>
            </label>
            <div class="truncate-2 font-medium">${escapeHtml(p.name)}</div>
            <div class="text-xs text-gray-500">${escapeHtml(p.brand||'—')} · ${escapeHtml(p.category||'—')}</div>
            <div class="flex items-center justify-between text-sm">
              <span class="font-semibold">NT$ ${(p.price/100).toLocaleString()}</span>
              <span class="${(p.stock||0)>0?'text-emerald-600':'text-gray-400'}">庫存 ${p.stock||0}</span>
            </div>
          </div>
        </div>`;
      }).join('');
      gridWrap.insertAdjacentHTML('beforeend', html);
      renderedCount += slice.length;
      selectAllEl.checked = slice.length>0 && slice.every(p => selected.has(p.sku));
    }

    // List 渲染（表格）
    function renderListTable(list, reset) {
      if (reset) listBody.innerHTML = '';
      const slice = list.slice(renderedCount, renderedCount + PAGE_SIZE);
      const html = slice.map(p => `
        <tr class="border-b">
          <td class="p-2"><input type="checkbox" data-sku="${escapeHtml(p.sku)}" class="pick rounded" ${selected.has(p.sku)?'checked':''}></td>
          <td class="p-2 font-mono">${escapeHtml(p.sku)}</td>
          <td class="p-2">${escapeHtml(p.name)}</td>
          <td class="p-2">${escapeHtml(p.brand||'—')}</td>
          <td class="p-2">${escapeHtml(p.category||'—')}</td>
          <td class="p-2 text-right">NT$ ${(p.price/100).toLocaleString()}</td>
          <td class="p-2 text-right">${p.stock||0}</td>
        </tr>`).join('');
      listBody.insertAdjacentHTML('beforeend', html);
      renderedCount += slice.length;
      selectAllEl.checked = slice.length>0 && slice.every(p => selected.has(p.sku));
    }

    // 事件
    function bindEvents() {
      qEl.addEventListener('input', (e)=>{ state.q = e.target.value.trim(); renderedCount=0; render(true); });
      clearSearchEl.addEventListener('click', ()=>{ qEl.value=''; state.q=''; renderedCount=0; render(true); });

      clearBrandEl.addEventListener('click', ()=>{ state.brand=null; document.querySelectorAll('.brand-radio').forEach(r=>r.checked=false); renderedCount=0; render(true); });
      clearCategoryEl.addEventListener('click', ()=>{ state.category=null; document.querySelectorAll('.category-radio').forEach(r=>r.checked=false); renderedCount=0; render(true); });
      onlyInStockEl.addEventListener('change', e=>{ state.onlyInStock = e.target.checked; renderedCount=0; render(true); });

      brandListEl.addEventListener('change', e => { if(e.target.classList.contains('brand-radio')){ state.brand = e.target.value; renderedCount=0; render(true); }});
      categoryListEl.addEventListener('change', e => { if(e.target.classList.contains('category-radio')){ state.category = e.target.value; renderedCount=0; render(true); }});

      modeToggleEl.addEventListener('change', e=>{ state.listMode = e.target.checked; renderedCount=0; render(true); });

      document.addEventListener('change', e=>{
        if (e.target.classList.contains('pick')) {
          const sku = e.target.getAttribute('data-sku');
          if (e.target.checked) selected.add(sku); else selected.delete(sku);
          render();
        }
      });

      selectAllEl.addEventListener('change', ()=>{
        const list = getFiltered();
        if (selectAllEl.checked) list.forEach(p=>selected.add(p.sku));
        else list.forEach(p=>selected.delete(p.sku));
        renderedCount=0; render(true);
      });

      loadMoreBtn.addEventListener('click', async ()=>{
        // 若目前已把已抓資料渲染完，且還有更多可抓，再抓一次；否則只渲染下一批
        const list = getFiltered();
        if (renderedCount >= list.length) {
          const before = allProducts.length;
          await fetchMore();
          const afterList = getFiltered();
          if (allProducts.length === before && renderedCount >= afterList.length) {
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = '已全部載入';
            return;
          }
        }
        render();
      });

      exportCsvBtn.addEventListener('click', exportCSV);
      exportZipBtn.addEventListener('click', exportImagesZip);
    }

    // 匯出 CSV（選取項）
    function exportCSV() {
      const picked = allProducts.filter(p => selected.has(p.sku));
      const headers = ['sku','name','brand','category','price','compare_at_price','status','stock','tags','slug','short_desc'];
      const lines = [headers.join(',')];
      for (const p of picked) {
        const row = headers.map(h => csvSafe(p[h]));
        lines.push(row.join(','));
      }
      const blob = new Blob([ '\uFEFF' + lines.join('\n') ], {type:'text/csv;charset=utf-8;'});
      saveAs(blob, `catalog_${new Date().toISOString().slice(0,10)}.csv`);
    }

    // 匯出圖片 ZIP（選取項）
    async function exportImagesZip() {
      exportZipBtn.disabled = true;
      exportZipBtn.textContent = '打包中…';

      const zip = new JSZip();
      const picked = allProducts.filter(p => selected.has(p.sku));

      // 取每個商品的圖片列表（若資料中沒附帶，呼叫 API）
      for (const p of picked) {
        let imgs = p.images;
        if (!imgs || imgs.length === 0) {
          try {
            const r = await fetch(`${API_BASE}/products/${encodeURIComponent(p.sku)}/images`);
            const j = await r.json();
            imgs = j.items || [];
          } catch {}
        }
        if (!imgs) continue;

        for (const im of imgs) {
          const url = `${IMAGE_BASE}/${encodeURIComponent(p.sku)}/${encodeURIComponent(im.filename)}`;
          try {
            const res = await fetch(url, {mode:'cors'});
            const blob = await res.blob();
            zip.file(`${p.sku}/${im.filename}`, blob);
          } catch {
            // 忽略抓取失敗的單張
          }
        }
      }

      const out = await zip.generateAsync({type:'blob'});
      saveAs(out, `assets_${new Date().toISOString().replace(/[:T]/g,'-').slice(0,16)}.zip`);
      exportZipBtn.textContent = '下載圖片（ZIP）';
      exportZipBtn.disabled = selected.size === 0;
    }

    // Utils
    function csvSafe(v){
      if (v === null || v === undefined) return '';
      const s = String(v);
      if (/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }
    function escapeHtml(s=''){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
