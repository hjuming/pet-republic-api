<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>商品清單｜Pet Republic</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- JSZip 用來在前端打包圖片 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-3gH2a+Tq9v9jRkL9eLBM7+cG2zq7b9Sk5sxS75cX0mE8b7p3uQ3m5e7wH2d+WgZqK9h7n6o+g0JpD4oyfKp1kA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <h1 class="text-lg font-bold">Pet Republic｜商品清單</h1>
      <div class="ml-auto flex items-center gap-2">
        <input id="search" type="search" placeholder="輸入關鍵字或 SKU…" class="w-64 md:w-80 rounded-lg border px-3 py-2">
        <button id="btnSearch" class="px-3 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700">搜尋</button>
        <div class="h-6 w-px bg-gray-300 mx-2"></div>
        <button id="toggleView" class="px-3 py-2 rounded-lg border hover:bg-gray-100" title="切換縮圖/清單">縮圖模式</button>
        <button id="btnCsv" class="px-3 py-2 rounded-lg border hover:bg-gray-100">匯出 CSV（已勾選）</button>
        <button id="btnZip" class="px-3 py-2 rounded-lg border hover:bg-gray-100">打包圖片 ZIP（已勾選）</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 md:grid-cols-4 gap-6">
    <!-- 側邊篩選 -->
    <aside class="md:col-span-1">
      <section class="bg-white rounded-xl border shadow-sm p-4 mb-4">
        <h2 class="font-semibold mb-3">品牌</h2>
        <div id="brandList" class="space-y-2 max-h-[320px] overflow-auto"></div>
      </section>
      <section class="bg-white rounded-xl border shadow-sm p-4">
        <h2 class="font-semibold mb-3">類別</h2>
        <div id="categoryList" class="space-y-2 max-h-[320px] overflow-auto"></div>
      </section>
    </aside>

    <!-- 清單 -->
    <section class="md:col-span-3">
      <div class="mb-3 text-sm text-gray-600">
        <span id="countInfo">載入中…</span>
      </div>
      <div id="grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>

      <div id="list" class="hidden divide-y bg-white rounded-xl border shadow-sm"></div>

      <!-- 分頁 -->
      <div class="mt-6 flex items-center justify-center gap-2">
        <button id="prev" class="px-3 py-2 rounded-lg border hover:bg-gray-100" disabled>上一頁</button>
        <span id="pageInfo" class="text-sm text-gray-600">第 1/1 頁</span>
        <button id="next" class="px-3 py-2 rounded-lg border hover:bg-gray-100" disabled>下一頁</button>
      </div>
    </section>
  </main>

  <footer class="text-center text-xs text-gray-500 py-6">
    API 狀態：<span id="apiStat">檢查中…</span>
  </footer>

<script>
/* ====== 環境設定（同源呼叫你的 Worker API）====== */
const API_BASE = ''; // 同源（image.wedo.pet 或 workers.dev）
const IMG_BASE = ''; // 走 Worker 的 /:sku/:filename 轉 R2

/* ====== UI 狀態 ====== */
let state = {
  q: '',
  brand: '',
  category: '',
  page: 1,
  size: 24,
  view: 'grid', // grid | list
  total: 0,
  items: [],
  selected: new Set(), // 存 sku
  facets: { brand: {}, category: {} },
};

/* ====== 工具 ====== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

function escapeCSV(val='') {
  const str = String(val ?? '');
  return /[",\n]/.test(str) ? `"${str.replace(/"/g,'""')}"` : str;
}
function download(filename, blob) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
function formatMoney(cents) {
  const n = Number(cents||0)/100;
  return `NT$${n.toLocaleString('zh-TW',{minimumFractionDigits:0})}`;
}

/* ====== API ====== */
async function fetchProducts() {
  const p = new URLSearchParams();
  if (state.q) p.set('q', state.q);
  if (state.brand) p.set('brand', state.brand);
  if (state.category) p.set('category', state.category);
  p.set('page', state.page);
  p.set('size', state.size);

  const res = await fetch(`${API_BASE}/api/products?`+p.toString());
  if (!res.ok) throw new Error('fetch products failed');
  const data = await res.json();
  state.items = data.items || [];
  state.total = data.total || 0;
  state.facets.brand = data.facets?.brand || {};
  state.facets.category = data.facets?.category || {};
}

async function fetchImagesBySKU(sku) {
  const res = await fetch(`${API_BASE}/api/products/${encodeURIComponent(sku)}/images`);
  if (!res.ok) return [];
  return res.json();
}

/* ====== Render ====== */
function renderFacets() {
  const brandBox = $('#brandList');
  brandBox.innerHTML = '';
  const allBtn = facetButton('全部', '', 'brand', !state.brand);
  brandBox.appendChild(allBtn);
  Object.entries(state.facets.brand).sort((a,b)=>b[1]-a[1]).forEach(([name,count])=>{
    brandBox.appendChild(facetButton(`${name}（${count}）`, name, 'brand', state.brand===name));
  });

  const catBox = $('#categoryList');
  catBox.innerHTML = '';
  const allCat = facetButton('全部', '', 'category', !state.category);
  catBox.appendChild(allCat);
  Object.entries(state.facets.category).sort((a,b)=>b[1]-a[1]).forEach(([name,count])=>{
    catBox.appendChild(facetButton(`${name}（${count}）`, name, 'category', state.category===name));
  });
}
function facetButton(label, value, kind, active) {
  const btn = document.createElement('button');
  btn.className = `w-full text-left px-3 py-1.5 rounded-lg border ${active?'bg-teal-50 border-teal-300 text-teal-700':'hover:bg-gray-50'}`;
  btn.textContent = label;
  btn.onclick = ()=>{
    state.page = 1;
    state[kind] = value;
    loadAndRender();
  };
  return btn;
}

function renderMeta() {
  const totalPages = Math.max(1, Math.ceil(state.total / state.size));
  $('#pageInfo').textContent = `第 ${state.page}/${totalPages} 頁`;
  $('#prev').disabled = state.page<=1;
  $('#next').disabled = state.page>=totalPages;
  $('#countInfo').textContent = `共有 ${state.total} 筆商品；已勾選 ${state.selected.size} 筆`;
  $('#toggleView').textContent = state.view==='grid' ? '縮圖模式' : '清單模式';
}

function productCard(p) {
  const wrap = document.createElement('div');
  wrap.className = 'bg-white rounded-xl border shadow-sm p-3 flex flex-col';
  wrap.innerHTML = `
    <label class="inline-flex items-center gap-2 mb-2">
      <input type="checkbox" class="chk accent-teal-600" data-sku="${p.sku}" ${state.selected.has(p.sku)?'checked':''}>
      <span class="text-sm text-gray-600">選取</span>
    </label>
    <img class="w-full aspect-[4/3] object-contain mb-2 bg-gray-50 rounded-md" src="${(p.cover_url||'').replace(/^http:/,'https:')}" onerror="this.src=''; this.classList.add('bg-gray-100')" alt="">
    <div class="font-semibold leading-snug">${p.name||p.sku}</div>
    <div class="text-sm text-gray-500 mt-1">SKU：${p.sku}</div>
    <div class="text-sm text-teal-700 mt-1">${formatMoney(p.price)}</div>
  `;
  return wrap;
}
function productRow(p) {
  const row = document.createElement('div');
  row.className = 'flex items-center gap-3 px-3 py-2';
  row.innerHTML = `
    <input type="checkbox" class="chk accent-teal-600" data-sku="${p.sku}" ${state.selected.has(p.sku)?'checked':''}>
    <img class="w-16 h-12 object-contain rounded bg-gray-50" src="${(p.cover_url||'').replace(/^http:/,'https:')}" onerror="this.src=''; this.classList.add('bg-gray-100')" alt="">
    <div class="flex-1">
      <div class="font-medium">${p.name||p.sku}</div>
      <div class="text-xs text-gray-500">SKU：${p.sku}｜品牌：${p.brand||'-'}｜類別：${p.category||'-'}</div>
    </div>
    <div class="text-sm text-teal-700">${formatMoney(p.price)}</div>
  `;
  return row;
}
function renderList() {
  // grid
  const grid = $('#grid'); grid.innerHTML='';
  // list
  const list = $('#list'); list.innerHTML='';

  if (state.view==='grid') {
    $('#grid').classList.remove('hidden');
    $('#list').classList.add('hidden');
    state.items.forEach(p => grid.appendChild(productCard(p)));
  } else {
    $('#grid').classList.add('hidden');
    $('#list').classList.remove('hidden');
    state.items.forEach(p => list.appendChild(productRow(p)));
  }

  $$('.chk').forEach(chk=>{
    chk.onchange = (e)=>{
      const sku = e.target.dataset.sku;
      if (e.target.checked) state.selected.add(sku); else state.selected.delete(sku);
      renderMeta();
    };
  });
}

/* ====== 匯出功能 ====== */
function exportCSV() {
  const rows = [['sku','name','brand','category','price','status']];
  const map = new Map(); // sku 去重
  state.items.forEach(p=>{ if(state.selected.has(p.sku)) map.set(p.sku,p); });
  if (map.size===0) { alert('請先勾選商品'); return; }
  Array.from(map.values()).forEach(p=>{
    rows.push([p.sku, p.name||'', p.brand||'', p.category||'', (p.price||0)/100, p.status||'']);
  });
  const csv = rows.map(r=>r.map(escapeCSV).join(',')).join('\n');
  download(`products_${map.size}.csv`, new Blob([csv],{type:'text/csv;charset=utf-8'}));
}

async function exportZIP() {
  const skus = Array.from(state.selected);
  if (skus.length===0) { alert('請先勾選商品'); return; }
  const zip = new JSZip();
  // 並行拉圖（控制同時 5 条）
  const concurrency = 5;
  let cursor = 0;
  async function worker() {
    while (cursor < skus.length) {
      const idx = cursor++;
      const sku = skus[idx];
      try {
        const imgs = await fetchImagesBySKU(sku); // [{filename}]
        if (!imgs.length) continue;
        for (const im of imgs) {
          const url = `${IMG_BASE}/${encodeURIComponent(sku)}/${encodeURIComponent(im.filename)}`;
          const res = await fetch(url, {cache:'no-store'});
          if (!res.ok) continue;
          const blob = await res.blob();
          zip.file(`${sku}/${im.filename}`, blob);
        }
      } catch(e) { console.warn('zip fetch error', e); }
    }
  }
  await Promise.all(new Array(concurrency).fill(0).map(worker));
  const blob = await zip.generateAsync({type:'blob'});
  download(`images_${skus.length}.zip`, blob);
}

/* ====== 事件 ====== */
$('#btnSearch').onclick = ()=>{ state.q = $('#search').value.trim(); state.page=1; loadAndRender(); };
$('#search').addEventListener('keydown', e=>{ if(e.key==='Enter') $('#btnSearch').click(); });
$('#prev').onclick = ()=>{ state.page--; loadAndRender(); };
$('#next').onclick = ()=>{ state.page++; loadAndRender(); };
$('#toggleView').onclick = ()=>{ state.view = state.view==='grid'?'list':'grid'; renderMeta(); renderList(); };
$('#btnCsv').onclick = exportCSV;
$('#btnZip').onclick = exportZIP;

/* ====== 主流程 ====== */
async function loadAndRender() {
  await fetchProducts();
  renderFacets();
  renderMeta();
  renderList();
}
(async function boot(){
  try {
    await loadAndRender();
    $('#apiStat').textContent = '連線正常';
  } catch (e) {
    console.error(e);
    $('#apiStat').textContent = '連線異常';
  }
})();
</script>
</body>
</html>
