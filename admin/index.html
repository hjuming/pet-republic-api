<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¯µå…’å…±å’Œåœ‹ï½œå•†å“ç®¡ç†ï¼ˆAdminï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .btn { @apply inline-flex items-center justify-center rounded-lg px-4 py-2 font-medium transition; }
    .btn-primary { @apply bg-teal-600 text-white hover:bg-teal-700; }
    .btn-gray { @apply bg-gray-100 text-gray-800 hover:bg-gray-200; }
    .btn-danger { @apply bg-rose-600 text-white hover:bg-rose-700; }
    .input { @apply w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500; }
    .label { @apply text-sm font-medium text-gray-700; }
    .badge { @apply inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold; }
    .badge-green { @apply bg-emerald-100 text-emerald-700; }
    .badge-gray { @apply bg-gray-100 text-gray-700; }
    .badge-amber { @apply bg-amber-100 text-amber-700; }
    .badge-rose { @apply bg-rose-100 text-rose-700; }
    .modal-mask { @apply fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50; }
    .card { @apply bg-white rounded-xl shadow border; }
    .table th { @apply text-left text-xs font-semibold tracking-wider text-gray-500 uppercase px-3 py-2; }
    .table td { @apply px-3 py-2 align-top text-sm; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold">ğŸ¾ å¯µå…’å…±å’Œåœ‹ï½œå•†å“ç®¡ç†</h1>
        <p class="text-sm text-gray-600">å‰ç«¯å–®æª”å¾Œå° Â· å°æ¥ Cloudflare Worker APIï¼ˆD1 + R2ï¼‰</p>
      </div>
      <div class="flex items-center gap-3">
        <button id="btn-new" class="btn btn-primary">ï¼‹ æ–°å¢å•†å“</button>
        <button id="btn-logout" class="btn btn-gray">ç™»å‡º</button>
      </div>
    </div>

    <!-- Login Card -->
    <div id="login-card" class="card p-6 max-w-md mx-auto hidden">
      <h2 class="text-lg font-semibold mb-4">ç™»å…¥ç®¡ç†ä»‹é¢</h2>
      <div class="space-y-3">
        <div>
          <label class="label">ä½¿ç”¨è€…åç¨±</label>
          <input id="login-username" type="text" class="input" placeholder="USERNAMEï¼ˆèˆ‡ Worker Secret ç›¸åŒï¼‰" />
        </div>
        <div>
          <label class="label">å¯†ç¢¼</label>
          <input id="login-password" type="password" class="input" placeholder="PASSWORDï¼ˆèˆ‡ Worker Secret ç›¸åŒï¼‰" />
        </div>
        <div class="flex items-center justify-end gap-2 pt-2">
          <button id="btn-login" class="btn btn-primary">ç™»å…¥</button>
        </div>
      </div>
      <p class="text-xs text-gray-500 mt-4">ç³»çµ±åƒ…å°‡ <code>username:password</code> çš„ base64 æš«å­˜æ–¼æœ¬æ©Ÿç€è¦½å™¨çš„ localStorageï¼Œç”¨æ–¼æ¯æ¬¡è«‹æ±‚çš„ Authorization Headerï¼ˆBasic Authï¼‰ã€‚</p>
    </div>

    <!-- Filters -->
    <div id="filters" class="card p-4 mb-4 hidden">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
        <div>
          <label class="label">é—œéµå­—</label>
          <input id="f-q" type="text" class="input" placeholder="SKU / åç¨±" />
        </div>
        <div>
          <label class="label">å“ç‰Œ</label>
          <input id="f-brand" type="text" class="input" placeholder="brand" />
        </div>
        <div>
          <label class="label">åˆ†é¡</label>
          <input id="f-category" type="text" class="input" placeholder="category" />
        </div>
        <div>
          <label class="label">ç‹€æ…‹</label>
          <select id="f-status" class="input">
            <option value="">ï¼ˆå…¨éƒ¨ï¼‰</option>
            <option value="active">active</option>
            <option value="draft">draft</option>
            <option value="archived">archived</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="btn-search" class="btn btn-primary w-full">æœå°‹</button>
        </div>
      </div>
    </div>

    <!-- List -->
    <div id="list-card" class="card overflow-hidden hidden">
      <div class="px-4 py-3 border-b bg-gray-50 flex items-center justify-between">
        <div class="text-sm text-gray-600">
          <span>æ¯é </span>
          <select id="page-size" class="border rounded-lg px-2 py-1 ml-1">
            <option>20</option><option>50</option><option>100</option>
          </select>
          <span class="ml-2">ç­†</span>
        </div>
        <div class="text-sm text-gray-600">
          API_BASEï¼š<code id="api-base-label"></code>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full table">
          <thead class="bg-gray-50">
            <tr>
              <th>SKU</th>
              <th>åç¨±</th>
              <th>å“ç‰Œ/åˆ†é¡</th>
              <th>å”®åƒ¹</th>
              <th>åº«å­˜</th>
              <th>ç‹€æ…‹</th>
              <th>å»ºç«‹æ™‚é–“</th>
              <th class="w-48">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tbl-rows" class="divide-y"></tbody>
        </table>
      </div>
      <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
        <div id="page-info" class="text-sm text-gray-600">â€”</div>
        <div class="flex items-center gap-2">
          <button id="btn-prev" class="btn btn-gray">ä¸Šä¸€é </button>
          <button id="btn-next" class="btn btn-gray">ä¸‹ä¸€é </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Modal -->
  <div id="modal-product" class="modal-mask hidden">
    <div class="card w-[680px] max-w-[94vw] p-6">
      <h3 id="modal-product-title" class="text-lg font-semibold mb-4">å•†å“</h3>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="label">SKU *</label>
          <input id="p-sku" class="input" />
        </div>
        <div>
          <label class="label">åç¨± *</label>
          <input id="p-name" class="input" />
        </div>
        <div>
          <label class="label">Slug</label>
          <input id="p-slug" class="input" />
        </div>
        <div>
          <label class="label">å“ç‰Œ</label>
          <input id="p-brand" class="input" />
        </div>
        <div>
          <label class="label">åˆ†é¡</label>
          <input id="p-category" class="input" />
        </div>
        <div>
          <label class="label">ç‹€æ…‹</label>
          <select id="p-status" class="input">
            <option value="active">active</option>
            <option value="draft">draft</option>
            <option value="archived">archived</option>
          </select>
        </div>
        <div>
          <label class="label">å”®åƒ¹ï¼ˆä»¥åˆ†è¨ˆï¼‰</label>
          <input id="p-price" type="number" class="input" placeholder="19900=NT$199" />
        </div>
        <div>
          <label class="label">åŸåƒ¹ï¼ˆä»¥åˆ†è¨ˆï¼‰</label>
          <input id="p-compare" type="number" class="input" />
        </div>
        <div>
          <label class="label">åº«å­˜</label>
          <input id="p-stock" type="number" class="input" />
        </div>
        <div>
          <label class="label">æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
          <input id="p-tags" class="input" placeholder="dog,toy,soft" />
        </div>
        <div class="col-span-2">
          <label class="label">çŸ­æè¿°</label>
          <textarea id="p-short" rows="2" class="input"></textarea>
        </div>
        <div class="col-span-2">
          <label class="label">æè¿°</label>
          <textarea id="p-desc" rows="3" class="input"></textarea>
        </div>
        <div class="col-span-2">
          <label class="label">è¦æ ¼ï¼ˆJSONï¼‰</label>
          <textarea id="p-specs" rows="3" class="input" placeholder='{"material":"cotton"}'></textarea>
        </div>
      </div>
      <div class="flex items-center justify-end gap-2 mt-5">
        <button id="btn-product-cancel" class="btn btn-gray">å–æ¶ˆ</button>
        <button id="btn-product-save" class="btn btn-primary">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- Images Modal -->
  <div id="modal-images" class="modal-mask hidden">
    <div class="card w-[860px] max-w-[96vw] p-6">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">åœ–ç‰‡ç®¡ç†ï¼š<span id="img-sku" class="font-mono"></span></h3>
        <button id="btn-images-close" class="btn btn-gray">é—œé–‰</button>
      </div>
      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="md:col-span-2">
          <div id="img-list" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
        </div>
        <div class="card p-4">
          <h4 class="font-semibold mb-2">ä¸Šå‚³åˆ° R2</h4>
          <form id="form-upload" class="space-y-2">
            <input type="file" id="file" class="block w-full text-sm" />
            <input type="text" id="filename" class="input" placeholder="æª”åï¼ˆé è¨­å–æª”æ¡ˆåï¼‰" />
            <input type="number" id="sort" class="input" placeholder="æ’åºï¼ˆé¸å¡«ï¼‰" />
            <input type="text" id="alt" class="input" placeholder="æ›¿ä»£æ–‡å­—ï¼ˆé¸å¡«ï¼‰" />
            <button class="btn btn-primary w-full" type="submit">ä¸Šå‚³ä¸¦å»ºç«‹ç´€éŒ„</button>
          </form>
          <p class="text-xs text-gray-500 mt-2">
            ä¸Šå‚³æœƒå‘¼å« <code>/api/upload/{sku}</code>ï¼Œæ¥è‘—å»ºç«‹ <code>product_images</code> ç´€éŒ„ã€‚
            å…¬é–‹åœ–ç‰‡ç¶²å€ï¼š<code>IMAGE_BASE/{sku}/{filename}</code>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg text-sm bg-gray-900 text-white shadow-lg hidden"></div>

  <script>
    // ====== åŸºæœ¬è¨­å®š ======
    const API_BASE = location.origin;                   // èˆ‡ Worker ç¶åˆ°çš„ç¶²åŸŸä¸€è‡´ï¼ˆä¾‹å¦‚ https://image.wedo.petï¼‰
    const IMAGE_BASE = "https://image.wedo.pet";        // å…¬é–‹åœ–åºŠç¶²åŸŸï¼ˆä½ çš„ R2 Gateway ç¶å®šç¶²åŸŸï¼‰
    const PAGE = { page: 1, size: 20 };

    // ====== DOM åƒç…§ ======
    const loginCard = document.getElementById('login-card');
    const filters = document.getElementById('filters');
    const listCard = document.getElementById('list-card');
    const apiBaseLabel = document.getElementById('api-base-label');

    const fQ = document.getElementById('f-q');
    const fBrand = document.getElementById('f-brand');
    const fCategory = document.getElementById('f-category');
    const fStatus = document.getElementById('f-status');
    const pageSize = document.getElementById('page-size');
    const btnSearch = document.getElementById('btn-search');

    const tblRows = document.getElementById('tbl-rows');
    const pageInfo = document.getElementById('page-info');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');

    const btnNew = document.getElementById('btn-new');
    const btnLogout = document.getElementById('btn-logout');

    // Product modal
    const modalProduct = document.getElementById('modal-product');
    const mpTitle = document.getElementById('modal-product-title');
    const pSKU = document.getElementById('p-sku');
    const pName = document.getElementById('p-name');
    const pSlug = document.getElementById('p-slug');
    const pBrand = document.getElementById('p-brand');
    const pCategory = document.getElementById('p-category');
    const pStatus = document.getElementById('p-status');
    const pPrice = document.getElementById('p-price');
    const pCompare = document.getElementById('p-compare');
    const pStock = document.getElementById('p-stock');
    const pTags = document.getElementById('p-tags');
    const pShort = document.getElementById('p-short');
    const pDesc = document.getElementById('p-desc');
    const pSpecs = document.getElementById('p-specs');
    const btnProductCancel = document.getElementById('btn-product-cancel');
    const btnProductSave = document.getElementById('btn-product-save');

    // Images modal
    const modalImages = document.getElementById('modal-images');
    const imgSKU = document.getElementById('img-sku');
    const imgList = document.getElementById('img-list');
    const btnImagesClose = document.getElementById('btn-images-close');
    const formUpload = document.getElementById('form-upload');
    const upFile = document.getElementById('file');
    const upFilename = document.getElementById('filename');
    const upSort = document.getElementById('sort');
    const upAlt = document.getElementById('alt');

    const toast = document.getElementById('toast');

    apiBaseLabel.textContent = API_BASE;

    // ====== Auth ======
    function getAuth() { return localStorage.getItem('pr_auth') || ''; }
    function setAuth(user, pass) { localStorage.setItem('pr_auth', 'Basic ' + btoa(user + ':' + pass)); }
    function clearAuth() { localStorage.removeItem('pr_auth'); }

    function needLoginUI() {
      loginCard.classList.remove('hidden');
      filters.classList.add('hidden');
      listCard.classList.add('hidden');
    }
    function showListUI() {
      loginCard.classList.add('hidden');
      filters.classList.remove('hidden');
      listCard.classList.remove('hidden');
    }

    document.getElementById('btn-login').addEventListener('click', async () => {
      const u = document.getElementById('login-username').value.trim();
      const p = document.getElementById('login-password').value;
      if (!u || !p) return toastMsg('è«‹è¼¸å…¥ä½¿ç”¨è€…åç¨±èˆ‡å¯†ç¢¼');
      setAuth(u, p);
      // è©¦æ¢å‘¼å«å—ä¿è­· APIï¼ˆç”¨æ–°å¢å•†å“ä½†ä¸é€è³‡æ–™æ”¹ç‚ºå‘¼å« /admin æ¯”è¼ƒè¼•ï¼‰
      const ok = await testAuth();
      if (ok) {
        showListUI();
        PAGE.page = 1;
        await refreshList();
      } else {
        clearAuth();
        toastMsg('ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³å¯†æˆ– CORS/ç¶²åŸŸè¨­å®š');
      }
    });

    document.getElementById('btn-logout').addEventListener('click', () => {
      clearAuth();
      needLoginUI();
    });

    async function testAuth() {
      try {
        const res = await fetch(API_BASE + '/admin', { headers: { Authorization: getAuth() } });
        return res.status !== 401;
      } catch { return false; }
    }

    // ====== Fetch helper ======
    async function api(path, options = {}, useAuth = false) {
      const headers = { 'content-type': 'application/json' };
      if (useAuth) headers['Authorization'] = getAuth();
      const res = await fetch(API_BASE + path, { ...options, headers: { ...headers, ...(options.headers || {}) } });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) return await res.json();
      return await res.text();
    }

    // ====== List & Search ======
    btnSearch.addEventListener('click', () => { PAGE.page = 1; refreshList(); });
    pageSize.addEventListener('change', () => { PAGE.size = parseInt(pageSize.value, 10) || 20; PAGE.page = 1; refreshList(); });
    btnPrev.addEventListener('click', () => { if (PAGE.page > 1) { PAGE.page--; refreshList(); } });
    btnNext.addEventListener('click', () => { PAGE.page++; refreshList(); });

    async function refreshList() {
      try {
        const params = new URLSearchParams();
        if (fQ.value.trim()) params.set('q', fQ.value.trim());
        if (fBrand.value.trim()) params.set('brand', fBrand.value.trim());
        if (fCategory.value.trim()) params.set('category', fCategory.value.trim());
        if (fStatus.value) params.set('status', fStatus.value);
        params.set('page', String(PAGE.page));
        params.set('size', String(PAGE.size));

        const data = await api('/api/products?' + params.toString(), { method: 'GET' });
        renderList(data);
      } catch (err) {
        console.error(err);
        toastMsg('è¼‰å…¥æ¸…å–®å¤±æ•—ï¼š' + err.message);
      }
    }

    function renderList(data) {
      const items = data.items || [];
      tblRows.innerHTML = items.map(row => {
        const statusBadge = row.status === 'active' ? 'badge badge-green' :
                            row.status === 'draft' ? 'badge badge-amber' : 'badge badge-gray';
        return `
          <tr>
            <td class="font-mono">${esc(row.sku)}</td>
            <td>${esc(row.name || '')}<div class="text-xs text-gray-500">${esc(row.short_desc || '')}</div></td>
            <td><div>${esc(row.brand || '-')}</div><div class="text-xs text-gray-500">${esc(row.category || '-')}</div></td>
            <td>NT$ ${(Number(row.price||0)/100).toFixed(2)}</td>
            <td>${Number(row.stock||0)}</td>
            <td><span class="${statusBadge} px-2">${esc(row.status)}</span></td>
            <td class="text-xs text-gray-500">${esc(row.created_at||'')}</td>
            <td class="space-x-2">
              <button class="btn btn-gray mb-1" onclick="openImages('${enc(row.sku)}')">åœ–ç‰‡</button>
              <button class="btn btn-primary mb-1" onclick="openEdit('${enc(row.sku)}')">ç·¨è¼¯</button>
              <button class="btn btn-danger mb-1" onclick="confirmDelete('${enc(row.sku)}')">åˆªé™¤</button>
            </td>
          </tr>`;
      }).join('');

      const total = data.total || 0;
      const start = total ? (data.page - 1) * data.size + 1 : 0;
      const end = Math.min(total, data.page * data.size);
      pageInfo.textContent = `ç¬¬ ${data.page} é ï¼Œé¡¯ç¤º ${start}-${end} / å…± ${total} ç­†`;
    }

    // ====== Create / Edit ======
    btnNew.addEventListener('click', () => openCreate());
    btnProductCancel.addEventListener('click', closeProduct);

    async function openCreate() {
      mpTitle.textContent = 'æ–°å¢å•†å“';
      pSKU.value = ''; pSKU.disabled = false;
      pName.value = ''; pSlug.value = ''; pBrand.value=''; pCategory.value='';
      pStatus.value='active'; pPrice.value=''; pCompare.value=''; pStock.value='0';
      pTags.value=''; pShort.value=''; pDesc.value=''; pSpecs.value='';
      modalProduct.classList.remove('hidden');

      btnProductSave.onclick = async () => {
        try {
          const payload = collectProductPayload(true);
          await api('/api/products', { method: 'POST', body: JSON.stringify(payload) , headers: { Authorization: getAuth() } }, true);
          toastMsg('æ–°å¢æˆåŠŸ');
          closeProduct();
          refreshList();
        } catch (err) {
          toastMsg('æ–°å¢å¤±æ•—ï¼š' + err.message);
        }
      };
    }

    async function openEdit(sku) {
      try {
        const data = await api('/api/products/' + encodeURIComponent(sku), { method: 'GET' });
        const item = data.item;
        mpTitle.textContent = 'ç·¨è¼¯å•†å“ï¼š' + item.sku;
        pSKU.value = item.sku; pSKU.disabled = true;
        pName.value = item.name || '';
        pSlug.value = item.slug || '';
        pBrand.value = item.brand || '';
        pCategory.value = item.category || '';
        pStatus.value = item.status || 'active';
        pPrice.value = item.price ?? '';
        pCompare.value = item.compare_at_price ?? '';
        pStock.value = item.stock ?? 0;
        pTags.value = item.tags || '';
        pShort.value = item.short_desc || '';
        pDesc.value = item.description || '';
        pSpecs.value = item.specs ? (typeof item.specs === 'string' ? item.specs : JSON.stringify(item.specs, null, 2)) : '';
        modalProduct.classList.remove('hidden');

        btnProductSave.onclick = async () => {
          try {
            const payload = collectProductPayload(false);
            await api('/api/products/' + encodeURIComponent(item.sku), { method: 'PUT', body: JSON.stringify(payload), headers: { Authorization: getAuth() } }, true);
            toastMsg('å„²å­˜æˆåŠŸ');
            closeProduct();
            refreshList();
          } catch (err) {
            toastMsg('å„²å­˜å¤±æ•—ï¼š' + err.message);
          }
        };
      } catch (err) {
        toastMsg('è®€å–å•†å“å¤±æ•—ï¼š' + err.message);
      }
    }

    function collectProductPayload(isCreate) {
      const payload = {
        sku: pSKU.value.trim(),
        name: pName.value.trim(),
        slug: emptyToNull(pSlug.value),
        brand: emptyToNull(pBrand.value),
        category: emptyToNull(pCategory.value),
        price: toInt(pPrice.value),
        compare_at_price: pCompare.value === '' ? null : toInt(pCompare.value),
        status: pStatus.value,
        stock: toInt(pStock.value),
        short_desc: emptyToNull(pShort.value),
        description: emptyToNull(pDesc.value),
        tags: emptyToNull(pTags.value),
      };
      const specsText = pSpecs.value.trim();
      if (specsText) {
        try { payload.specs = JSON.parse(specsText); }
        catch { throw new Error('è¦æ ¼(JSON) æ ¼å¼éŒ¯èª¤'); }
      } else {
        payload.specs = null;
      }
      if (isCreate && !payload.sku) throw new Error('SKU å¿…å¡«');
      if (isCreate && !payload.name) throw new Error('åç¨± å¿…å¡«');
      return payload;
    }

    function closeProduct() { modalProduct.classList.add('hidden'); }

    async function confirmDelete(sku) {
      if (!confirm(`ç¢ºå®šåˆªé™¤å•†å“ ${sku}ï¼Ÿæ­¤å‹•ä½œæœƒä¸€ä½µåˆªé™¤æ­¤ SKU çš„åœ–ç‰‡ç´€éŒ„ï¼`)) return;
      try {
        await api('/api/products/' + encodeURIComponent(sku), { method: 'DELETE', headers: { Authorization: getAuth() } }, true);
        toastMsg('å·²åˆªé™¤ï¼š' + sku);
        refreshList();
      } catch (err) {
        toastMsg('åˆªé™¤å¤±æ•—ï¼š' + err.message);
      }
    }

    // ====== Images ======
    window.openImages = async function(sku) {
      imgSKU.textContent = sku;
      modalImages.classList.remove('hidden');
      await loadImages(sku);
    };
    btnImagesClose.addEventListener('click', () => modalImages.classList.add('hidden'));

    async function loadImages(sku) {
      try {
        const data = await api('/api/products/' + encodeURIComponent(sku) + '/images', { method: 'GET' });
        const items = data.items || [];
        imgList.innerHTML = items.map(r => {
          const url = `${IMAGE_BASE}/${encodeURIComponent(r.sku)}/${encodeURIComponent(r.filename)}`;
          return `
          <div class="border rounded-lg overflow-hidden">
            <div class="aspect-video bg-gray-100">
              <img src="${url}" alt="${esc(r.alt||'')}" class="w-full h-full object-cover" loading="lazy" />
            </div>
            <div class="p-2 text-xs">
              <div class="font-mono">${esc(r.filename)}</div>
              <div class="text-gray-500">sort: ${Number(r.sort||0)}</div>
              <div class="mt-2 flex items-center gap-2">
                <a class="btn btn-gray text-xs" href="${url}" target="_blank" rel="noopener">é–‹æ–°è¦–çª—</a>
                <button class="btn btn-danger text-xs" onclick="delImg('${enc(r.sku)}','${enc(r.filename)}')">åˆªé™¤ç´€éŒ„</button>
              </div>
            </div>
          </div>`;
        }).join('') || `<div class="text-sm text-gray-500">å°šç„¡åœ–ç‰‡ç´€éŒ„</div>`;
      } catch (err) {
        toastMsg('è¼‰å…¥åœ–ç‰‡å¤±æ•—ï¼š' + err.message);
      }
    }

    window.delImg = async function(sku, filename) {
      if (!confirm(`åˆªé™¤åœ–ç‰‡ç´€éŒ„ï¼š${filename}ï¼Ÿï¼ˆä¸æœƒåˆª R2 æª”ï¼‰`)) return;
      try {
        await api(`/api/products/${encodeURIComponent(sku)}/images/${encodeURIComponent(filename)}`, { method: 'DELETE', headers: { Authorization: getAuth() } }, true);
        toastMsg('å·²åˆªé™¤ç´€éŒ„');
        loadImages(sku);
      } catch (err) {
        toastMsg('åˆªé™¤å¤±æ•—ï¼š' + err.message);
      }
    };

    formUpload.addEventListener('submit', async (e) => {
      e.preventDefault();
      const sku = imgSKU.textContent.trim();
      const file = upFile.files[0];
      if (!file) return toastMsg('è«‹é¸æ“‡æª”æ¡ˆ');
      const filename = upFilename.value.trim() || file.name;
      try {
        // 1) ä¸Šå‚³åˆ° R2
        const fd = new FormData();
        fd.append('file', file);
        fd.append('filename', filename);
        const res = await fetch(`${API_BASE}/api/upload/${encodeURIComponent(sku)}`, {
          method: 'POST',
          headers: { Authorization: getAuth() },
          body: fd
        });
        if (!res.ok) throw new Error('ä¸Šå‚³å¤±æ•— ' + res.status);
        const up = await res.json();

        // 2) æ–°å¢åœ–ç‰‡ç´€éŒ„
        const body = {
          filename: filename,
          r2_key: `${sku}/${filename}`,
          alt: upAlt.value.trim() || null,
          sort: upSort.value ? Number(upSort.value) : 0
        };
        await api(`/api/products/${encodeURIComponent(sku)}/images`, {
          method: 'POST',
          headers: { Authorization: getAuth() },
          body: JSON.stringify(body)
        }, true);

        toastMsg('ä¸Šå‚³å®Œæˆä¸¦å»ºç«‹ç´€éŒ„');
        upFile.value = ''; upFilename.value=''; upSort.value=''; upAlt.value='';
        loadImages(sku);
      } catch (err) {
        toastMsg(err.message);
      }
    });

    // ====== Helpers ======
    function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function enc(s){ return encodeURIComponent(s); }
    function toInt(n){ const v = Number(n); return Number.isFinite(v)? Math.trunc(v):0; }
    function emptyToNull(v){ const s = (v??'').trim(); return s ? s : null; }
    function toastMsg(msg){
      toast.textContent = msg;
      toast.classList.remove('hidden','opacity-0');
      setTimeout(()=>toast.classList.add('hidden'), 2600);
    }

    // ====== åˆå§‹åŒ– ======
    (async function init(){
      if (!getAuth()) {
        needLoginUI();
        return;
      }
      const ok = await testAuth();
      if (!ok) { needLoginUI(); return; }
      showListUI();
      pageSize.value = PAGE.size;
      refreshList();
    })();

    // è®“å…¨åŸŸå¯ç”¨ï¼ˆfor inline onclickï¼‰
    window.openEdit = openEdit;
    window.confirmDelete = confirmDelete;
  </script>
</body>
</html>
