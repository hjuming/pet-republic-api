<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>寵兒共和國｜後台管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .input { @apply w-full rounded-lg border-gray-300; }
    .label { @apply text-sm text-gray-600; }
  </style>
</head>
<body class="bg-gray-50">
  <header class="sticky top-0 z-40 bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <h1 class="text-xl font-bold">後台管理</h1>
      <a href="/" class="text-sm text-teal-700 hover:underline">回前台</a>
      <div class="ml-auto flex items-center gap-2">
        <a href="/sync-airtable" class="px-3 py-2 text-sm rounded-lg border hover:bg-gray-50">Airtable 同步</a>
        <button id="newBtn" class="px-3 py-2 text-sm rounded-lg bg-teal-600 text-white">新增商品</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-12 gap-6">
    <!-- 左：列表 -->
    <section class="col-span-12 md:col-span-5">
      <div class="bg-white border rounded-xl">
        <div class="p-3 border-b flex items-center gap-2">
          <input id="listSearch" placeholder="搜尋 SKU / 名稱" class="w-full rounded-lg border-gray-300" />
          <button id="reloadBtn" class="px-3 py-2 text-sm rounded-lg border hover:bg-gray-50">重新整理</button>
        </div>
        <div id="listBox" class="max-h-[70vh] overflow-auto divide-y"></div>
      </div>
    </section>

    <!-- 右：表單 -->
    <section class="col-span-12 md:col-span-7">
      <form id="formBox" class="bg-white border rounded-xl p-4 space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="label">SKU</label>
            <input name="sku" required class="input" />
          </div>
          <div>
            <label class="label">Slug</label>
            <input name="slug" class="input" />
          </div>
          <div class="col-span-2">
            <label class="label">商品名稱</label>
            <input name="name" required class="input" />
          </div>
          <div>
            <label class="label">品牌</label>
            <input name="brand" class="input" />
          </div>
          <div>
            <label class="label">分類</label>
            <input name="category" class="input" />
          </div>
          <div>
            <label class="label">售價（NT$）</label>
            <input name="price" type="number" min="0" class="input" />
          </div>
          <div>
            <label class="label">原價（NT$）</label>
            <input name="compare_at_price" type="number" min="0" class="input" />
          </div>
          <div>
            <label class="label">庫存</label>
            <input name="stock" type="number" min="0" class="input" />
          </div>
          <div>
            <label class="label">狀態</label>
            <select name="status" class="input">
              <option value="active">active</option>
              <option value="draft">draft</option>
              <option value="archived">archived</option>
            </select>
          </div>
          <div class="col-span-2">
            <label class="label">標籤（逗號分隔）</label>
            <input name="tags" class="input" />
          </div>
          <div class="col-span-2">
            <label class="label">短描述</label>
            <textarea name="short_desc" rows="2" class="input"></textarea>
          </div>
          <div class="col-span-2">
            <label class="label">詳細描述（支援純文字/安全 HTML）</label>
            <textarea name="description" rows="6" class="input"></textarea>
          </div>
          <div class="col-span-2">
            <label class="label">規格（JSON）</label>
            <textarea name="specs" rows="4" class="input" placeholder='{"材質":"…","尺寸":"…"}'></textarea>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="saveBtn" type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">儲存</button>
          <button id="deleteBtn" type="button" class="px-4 py-2 rounded-lg border border-red-300 text-red-700">刪除</button>
          <span id="msg" class="text-sm text-gray-500"></span>
        </div>

        <!-- 圖片管理 -->
        <div class="border-t pt-4">
          <h3 class="font-semibold mb-2">圖片</h3>
          <div class="flex items-center gap-2 mb-3">
            <input id="imgFile" type="file" accept="image/*" class="text-sm" />
            <input id="imgName" placeholder="檔名（例：1.jpg）" class="rounded-lg border-gray-300 text-sm" />
            <button id="uploadImgBtn" type="button" class="px-3 py-2 text-sm rounded-lg border hover:bg-gray-50">上傳</button>
          </div>
          <div id="imgList" class="grid grid-cols-3 gap-3"></div>
        </div>
      </form>
    </section>
  </main>

  <script>
    const API_BASE = '/api';
    const IMAGE_BASE = 'https://image.wedo.pet';

    const listBox = document.getElementById('listBox');
    const listSearch = document.getElementById('listSearch');
    const reloadBtn = document.getElementById('reloadBtn');
    const formBox = document.getElementById('formBox');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const newBtn = document.getElementById('newBtn');
    const msg = document.getElementById('msg');

    const imgFile = document.getElementById('imgFile');
    const imgName = document.getElementById('imgName');
    const uploadImgBtn = document.getElementById('uploadImgBtn');
    const imgList = document.getElementById('imgList');

    let cache = [];
    let current = null;

    init();
    async function init(){
      await loadList();
      bind();
      if (cache[0]) loadToForm(cache[0]);
    }

    async function loadList() {
      const res = await fetch(`${API_BASE}/products?limit=1000`);
      const json = await res.json();
      cache = json.items || [];
      renderList();
    }

    function renderList() {
      const q = (listSearch.value||'').toLowerCase();
      const items = cache.filter(p => (p.sku||'').toLowerCase().includes(q) || (p.name||'').toLowerCase().includes(q));
      listBox.innerHTML = items.map(p => `
        <button data-sku="${escapeHtml(p.sku)}" class="w-full text-left p-3 hover:bg-gray-50 ${current?.sku===p.sku?'bg-teal-50':''}">
          <div class="text-sm font-medium">${escapeHtml(p.name||'')}</div>
          <div class="text-xs text-gray-500">${escapeHtml(p.sku)} · ${escapeHtml(p.brand||'—')} · ${escapeHtml(p.category||'—')}</div>
        </button>
      `).join('');
    }

    function bind(){
      listSearch.addEventListener('input', renderList);
      reloadBtn.addEventListener('click', async ()=>{ await loadList(); if(current){const found=cache.find(x=>x.sku===current.sku); if(found) loadToForm(found);} });
      listBox.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-sku]');
        if (!btn) return;
        const sku = btn.getAttribute('data-sku');
        const p = cache.find(x=>x.sku===sku);
        if (p) loadToForm(p);
      });

      newBtn.addEventListener('click', ()=>{
        current = null;
        formBox.reset();
        imgList.innerHTML = '';
        msg.textContent = '新增模式';
      });

      formBox.addEventListener('submit', onSave);
      deleteBtn.addEventListener('click', onDelete);

      uploadImgBtn.addEventListener('click', onUploadImage);
      imgList.addEventListener('click', onImageAction);
    }

    function loadToForm(p){
      current = p;
      formBox.sku.value = p.sku || '';
      formBox.slug.value = p.slug || '';
      formBox.name.value = p.name || '';
      formBox.brand.value = p.brand || '';
      formBox.category.value = p.category || '';
      formBox.price.value = (p.price||0)/100;
      formBox.compare_at_price.value = (p.compare_at_price||0)/100;
      formBox.stock.value = p.stock||0;
      formBox.status.value = p.status||'active';
      formBox.tags.value = p.tags || '';
      formBox.short_desc.value = p.short_desc || '';
      formBox.description.value = p.description || '';
      formBox.specs.value = p.specs ? (typeof p.specs==='string'?p.specs:JSON.stringify(p.specs, null, 2)) : '';
      msg.textContent = '';

      loadImages(p.sku);
    }

    async function onSave(e){
      e.preventDefault();
      const body = {
        sku: formBox.sku.value.trim(),
        slug: formBox.slug.value.trim() || null,
        name: formBox.name.value.trim(),
        brand: formBox.brand.value.trim() || null,
        category: formBox.category.value.trim() || null,
        price: Math.round(Number(formBox.price.value||0) * 100),
        compare_at_price: formBox.compare_at_price.value ? Math.round(Number(formBox.compare_at_price.value) * 100) : null,
        stock: Number(formBox.stock.value||0),
        status: formBox.status.value,
        tags: formBox.tags.value || null,
        short_desc: formBox.short_desc.value || null,
        description: formBox.description.value || null,
        specs: formBox.specs.value ? safeJson(formBox.specs.value) : null
      };
      if (!body.sku || !body.name) { msg.textContent='請填 SKU 與名稱'; return; }

      const isEdit = !!(current && current.sku === body.sku);
      const url = `${API_BASE}/products${isEdit?'/'+encodeURIComponent(body.sku):''}`;
      const method = isEdit ? 'PUT' : 'POST';
      const res = await fetch(url, {method, headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
      if (!res.ok) { msg.textContent = '儲存失敗'; return; }
      msg.textContent = '已儲存';
      await loadList();
      const latest = cache.find(x=>x.sku===body.sku);
      if (latest) loadToForm(latest);
    }

    async function onDelete(){
      if (!current) return;
      if (!confirm(`確定刪除 ${current.sku}?`)) return;
      const res = await fetch(`${API_BASE}/products/${encodeURIComponent(current.sku)}`, {method:'DELETE'});
      if (!res.ok) { msg.textContent='刪除失敗'; return; }
      msg.textContent='已刪除';
      await loadList();
      current = null;
      formBox.reset();
      imgList.innerHTML='';
    }

    async function loadImages(sku){
      imgList.innerHTML = '<div class="text-sm text-gray-400">讀取中…</div>';
      try{
        const r = await fetch(`${API_BASE}/products/${encodeURIComponent(sku)}/images`);
        const j = await r.json();
        const items = j.items || [];
        if (items.length===0){ imgList.innerHTML = '<div class="text-sm text-gray-400">尚無圖片</div>'; return; }
        imgList.innerHTML = items.map(im=>`
          <div class="border rounded-lg overflow-hidden">
            <div class="aspect-[4/3] bg-gray-100 flex items-center justify-center">
              <img src="${IMAGE_BASE}/${encodeURIComponent(sku)}/${encodeURIComponent(im.filename)}" class="max-h-full" alt="">
            </div>
            <div class="p-2 text-xs flex items-center justify-between">
              <span class="truncate">${escapeHtml(im.filename)}</span>
              <div class="flex items-center gap-2">
                <button class="text-blue-600 hover:underline" data-act="alt" data-fn="${escapeHtml(im.filename)}">Alt</button>
                <button class="text-red-600 hover:underline" data-act="del" data-fn="${escapeHtml(im.filename)}">刪除</button>
              </div>
            </div>
          </div>
        `).join('');
      }catch{
        imgList.innerHTML = '<div class="text-sm text-red-600">讀取失敗</div>';
      }
    }

    async function onUploadImage(){
      if (!current) { alert('請先選擇商品'); return; }
      const file = imgFile.files[0];
      const filename = (imgName.value || (file && file.name) || '').trim();
      if (!file || !filename){ alert('請選擇檔案與檔名'); return; }
      const fd = new FormData();
      fd.append('file', file);
      fd.append('filename', filename);
      const r = await fetch(`${API_BASE}/images/${encodeURIComponent(current.sku)}`, {method:'POST', body:fd});
      if (!r.ok) { alert('上傳失敗'); return; }
      imgFile.value=''; imgName.value='';
      await loadImages(current.sku);
    }

    async function onImageAction(e){
      const btn = e.target.closest('button[data-act]');
      if (!btn || !current) return;
      const sku = current.sku;
      const act = btn.getAttribute('data-act');
      const fn = btn.getAttribute('data-fn');
      if (act === 'del'){
        if (!confirm(`刪除圖片 ${fn}?`)) return;
        const r = await fetch(`${API_BASE}/images/${encodeURIComponent(sku)}/${encodeURIComponent(fn)}`, {method:'DELETE'});
        if (!r.ok){ alert('刪除失敗'); return; }
        await loadImages(sku);
      } else if (act === 'alt') {
        const alt = prompt('輸入 alt（可留空）：') ?? '';
        await fetch(`${API_BASE}/images/${encodeURIComponent(sku)}/${encodeURIComponent(fn)}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({alt})});
        await loadImages(sku);
      }
    }

    // Utils
    function safeJson(s){ try{ return JSON.parse(s); }catch{ return null; } }
    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  </script>
</body>
</html>
